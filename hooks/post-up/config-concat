#!/bin/bash

# Hook for enabling modular configuration for applications
# with no native support for it, by automatically generating
# configs by concatenating all files in a .d directory.

HEADER='# ::: Auto-generated by rcm post-up hook. :::'

# Function for creating the file $1 by concatenating
# all files in the directory $1.d
concat_config () {
	if [ -d "${1}.d" ]; then
		ok=0
		if [ -a "$1" ] || [ -L "$1" ]; then
			if [ ! -r "$1" ]; then
				ask=1
			elif ! head -n 1 "$1" | grep "$HEADER" &> /dev/null; then
				ask=1
			else
				ask=0
			fi

			if [ $ask -eq 1 ]; then
				read -p "$1: file already exists, overwrite? [y/n] " yn
				case $yn in
					[Yy]* ) ok=0;;
					* ) ok=1;;
				esac
			fi

			if [ $ok -eq 0 ]; then
				chmod u+w $1
				rm $1
			fi
		fi

		if [ $ok -eq 0 ]; then
			echo "$HEADER" > $1
			echo "" >> $1
			cat ${1}.d/* >> $1
			chmod u-w $1

		fi
	fi
}

concat_config "$HOME/.i3/config"
concat_config "$HOME/.i3status.conf"
